<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>🔒 加密 1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* 内联样式，确保密码输入框正常显示 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .password-input {
      width: 100%;
      padding: 0.8rem;
      margin: 1rem 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    .remember-password {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin: 0.8rem 0;
      font-size: 0.9rem;
      color: #666;
    }
    .remember-password input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    .remember-password label {
      cursor: pointer;
    }
    .btn-group {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
    }
    .confirm-btn, .reset-btn {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .confirm-btn {
      background: #42b983;
      color: #fff;
    }
    .confirm-btn:hover {
      background: #369870;
    }
    .reset-btn {
      background: #f0f0f0;
      color: #333;
    }
    .reset-btn:hover {
      background: #e0e0e0;
    }
    .error-tip {
      color: #ff4757;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }
    .count-tip {
      color: #ffa502;
      font-size: 0.8rem;
      margin: 0.5rem 0;
    }
    .access-hint {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    }
    #app {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="password-protected">
      <div class="modal" id="passwordModal">
        <div class="modal-content">
          <h3>请输入访问密码</h3>
          <input
            type="password"
            id="passwordInput"
            placeholder="输入密码后查看内容"
            class="password-input"
            onkeyup="if(event.key==='Enter') verifyPassword()"
          />
          <div class="remember-password">
            <input type="checkbox" id="remember" />
            <label for="remember">记住密码（7天有效）</label>
          </div>
          <div class="btn-group">
            <button onclick="verifyPassword()" class="confirm-btn">确认</button>
            <button onclick="document.getElementById('passwordInput').value=''" class="reset-btn">清空</button>
          </div>
          <p class="error-tip" id="errorTip" style="display: none;"></p>
          <p class="count-tip">剩余尝试次数：<span id="remainingTimes">3</span></p>
        </div>
      </div>

      <div class="access-hint">
        <p>🔒 本页面为加密内容，请输入正确的访问密码。</p>
        <p>💾 勾选"记住密码"后，7天内无需重新输入。</p>
      </div>
    </div>
  </div>

  <script>
    // 配置
    const CONFIG = {
      encryptedContent: `XG7wO8wdHAs5TUzx5kVogz10TqY036dx69xxlmHnjGGrmJq+mPHejuoohJkGpDkJHvebdwfgqs6q3j5UbPjO1hSpMfiL+63svGDpZ3oAQ1hB7nFzDrl9EgmPLWimwVRM59EyP+4yZyJK+WovPmktLAIV+rhIdPibM9Ppz75l28UNoBfje9Eyf2dZ2Yz/JFxMTiang3OotkFaGKeWzw/Djz+8RlERPzvT1fOOo4dMJZ4OQDZrJuGpPrRhjM0hwYQFsznYxy4zIrRtItRGUIJtxUNYd21uyI4UDdkrJ2dMKD30lLzFl1ba7d8DMXiIA4IoKZsogU+2T7ULQzLLqVi14NKyWmJGSODq/gaCqNNghe6wZUuqunsYWJP3Y9/jLGouu/0q4eXn5Df9eL2HsWE79Z48LglaSnOJnp8lOrPRJWXRA1cxFLBZXOsZ9LJCj9wFlVQM6oL2gLRaGcq1FTcPQOdZzGJWwy3w3bM4Sc88/Xv2eHSuTOxBGJDaTAbjgMVxU8UV9MOki+1r9RBgN2XPJJSucJ7UrnydwfLjOrckNvQ0txdj7Y2B4+TDkKwOz513EQcEp4prMV2z7VQlDLh2TXVZWODQnAf02oETeoHVgnq/G7VN2nidDDo1CbdLM+tHGQzlwTOFc7pgMwBXBqTYg97hLUYqaGP01bsJQAkflfRBhOB6GUdNcYJG0a/jlGN+jnXF8AeCDJu6QSmWsu6atHkdMeITKTvDRswAaYu6zAukyAAOsyCDR/mJCSTCCCK1/IrXvuVUrZMwPmhfJKWwZBpMQ4AaH06lhX8tFCRPxVL2ZB1D+8cLkbIzddZ2SvACNh93zyubBVc4hOCNXv8BTaPrP/hwRKmtSC0/hMxcj+N26fhUYbDN+q6ua39DtyLlgLMKiYR3BHKebRhJt3DgqEoNEoyT9lNfxohl+hUBaI0fT0Ez7i0QJr3ZuK22PL/Dql++It2Ymbi5vUcflbnYq3cgNjU15/NVYzBIDTk/5i0uaA346tY8bRsNkOKCqs4QYkoeGvwp0Rz9/EngWmh0MIaOJ2wvFnGKB/X4HHQMJ8J5oxEEFZrEpmG9Um1UPOVJ03pp533clqimBNTgjnvrsjTJxRMIUQ/GHOttx58f0lkFGB1D8cPmMOeks0NTlCqLx14u3aOorBGw3bvTsXjcTQ==`,
      originalPath: '/encrypt/encrypt01.html',
      iv: 'R7NTHazlPUSciblN', // 与环境变量 AES_IV 保持一致
      maxRetries: 3
    };

    // 移除页面中的图标元素
    function removePageIcons() {
      // 移除侧边栏链接中的图标
      const sidebarLinks = document.querySelectorAll('.vp-sidebar-link');
      sidebarLinks.forEach(link => {
        const iconElements = link.querySelectorAll('iconify-icon');
        iconElements.forEach(icon => icon.remove());
      });

      // 移除页面标题中的图标
      const titleIcons = document.querySelectorAll('h1 iconify-icon');
      titleIcons.forEach(icon => icon.remove());

      // 移除页面中的所有其他图标元素
      const allIcons = document.querySelectorAll('iconify-icon');
      allIcons.forEach(icon => icon.remove());
    }

    // 全局变量
    let remainingTimes = CONFIG.maxRetries;

    // 密码填充函数（与加密时保持一致）
    function padKeyTo32Bytes(key) {
      if (key.length >= 32) {
        return key.substring(0, 32);
      }
      let paddedKey = key;
      while (paddedKey.length < 32) {
        paddedKey += key;
      }
      return paddedKey.substring(0, 32);
    }

    // 加密密码用于存储
    function encryptPasswordForStorage(password) {
      try {
        const storageKey = 'vuepress_storage_key_2024';
        const storageIv = 'storage_iv_16byte';

        const paddedKey = padKeyTo32Bytes(storageKey);
        const key = CryptoJS.enc.Utf8.parse(paddedKey);
        const iv = CryptoJS.enc.Utf8.parse(storageIv);

        const encrypted = CryptoJS.AES.encrypt(password, key, {
          iv: iv,
          mode: CryptoJS.mode.CBC,
          padding: CryptoJS.pad.Pkcs7
        });

        return encrypted.toString();
      } catch (error) {
        console.warn('密码加密失败:', error);
        return null;
      }
    }

    // 解密存储的密码
    function decryptPasswordFromStorage(encryptedPassword) {
      try {
        const storageKey = 'vuepress_storage_key_2024';
        const storageIv = 'storage_iv_16byte';

        const paddedKey = padKeyTo32Bytes(storageKey);
        const key = CryptoJS.enc.Utf8.parse(paddedKey);
        const iv = CryptoJS.enc.Utf8.parse(storageIv);

        const decrypted = CryptoJS.AES.decrypt(encryptedPassword, key, {
          iv: iv,
          mode: CryptoJS.mode.CBC,
          padding: CryptoJS.pad.Pkcs7
        });

        const decryptedStr = CryptoJS.enc.Utf8.stringify(decrypted);
        return decryptedStr;
      } catch (error) {
        console.warn('密码解密失败:', error);
        return null;
      }
    }

    // 验证密码并解密内容
    function verifyPassword() {
      const inputPassword = document.getElementById('passwordInput').value;
      const errorTip = document.getElementById('errorTip');
      const remainingTimesSpan = document.getElementById('remainingTimes');

      if (!inputPassword) {
        showError('请输入密码！');
        return;
      }

      try {
        // 调试信息
        console.log('🔍 开始密码验证');
        console.log('输入密码:', inputPassword);
        console.log('密码长度:', inputPassword.length);

        // 配置AES解密参数
        const paddedKey = padKeyTo32Bytes(inputPassword);
        console.log('填充后密钥:', paddedKey);
        console.log('填充后密钥长度:', paddedKey.length);

        const key = CryptoJS.enc.Utf8.parse(paddedKey);
        const iv = CryptoJS.enc.Utf8.parse(CONFIG.iv);
        console.log('IV:', CONFIG.iv);

        // 执行解密
        const decrypted = CryptoJS.AES.decrypt(
          CONFIG.encryptedContent,
          key,
          { iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 }
        );

        console.log('解密对象:', decrypted.toString());
        console.log('解密对象类型:', typeof decrypted.toString());

        // 转换解密结果为字符串
        const decryptedStr = CryptoJS.enc.Utf8.stringify(decrypted);
        console.log('解密字符串:', decryptedStr);
        console.log('解密字符串长度:', decryptedStr.length);
        console.log('解密字符串是否为空:', !decryptedStr);
        console.log('解密字符串trim后是否为空:', decryptedStr.trim() === '');

        // 检查解密结果
        console.log('🔍 检查解密结果条件:');
        console.log('!decryptedStr:', !decryptedStr);
        console.log('decryptedStr.trim() === "":', decryptedStr.trim() === '');
        console.log('条件结果:', !decryptedStr || decryptedStr.trim() === '');

        if (!decryptedStr || decryptedStr.trim() === '') {
          console.log('❌ 进入错误处理分支');
          handleError();
          return;
        } else {
          console.log('✅ 解密验证通过，进入成功处理分支');
        }

        // 解密成功：保存密码（如果需要）并显示内容
        console.log('🔍 开始成功处理分支');

        if (document.getElementById('remember').checked) {
          console.log('💾 保存密码到本地存储');
          savePassword(inputPassword);
        } else {
          console.log('🔓 不保存密码');
        }

        console.log('🔄 开始替换页面内容');
        // 使用更安全的方式替换页面内容
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = decryptedStr;
        console.log('📝 创建临时容器，内容长度:', decryptedStr.length);

        // 替换整个 body 内容
        const bodyContent = tempDiv.querySelector('body');
        if (bodyContent) {
          console.log('📄 找到body元素，开始替换');
          document.body.innerHTML = bodyContent.innerHTML;
          console.log('✅ body内容替换完成');
        } else {
          console.log('❌ 未找到body元素');
        }

        // 更新页面标题
        const newTitle = tempDiv.querySelector('title');
        if (newTitle) {
          console.log('🏷️ 更新页面标题为:', newTitle.textContent);
          document.title = newTitle.textContent;
        } else {
          console.log('⚠️ 未找到标题元素');
        }

        console.log('✅ 成功处理分支完成');

        // 执行新内容中的脚本
        const scripts = tempDiv.querySelectorAll('script');
        scripts.forEach(script => {
          const newScript = document.createElement('script');
          if (script.src) {
            newScript.src = script.src;
          } else {
            newScript.textContent = script.textContent;
          }
          document.head.appendChild(newScript);
        });

        // 解密完成后立即移除页面中的图标元素
        setTimeout(() => {
          removePageIcons();
        }, 100);

      } catch (err) {
        handleError();
      }
    }

    // 处理解密失败
    function handleError() {
      remainingTimes--;
      const remainingTimesSpan = document.getElementById('remainingTimes');
      remainingTimesSpan.textContent = remainingTimes;

      if (remainingTimes <= 0) {
        showError('尝试次数过多，请刷新页面重试！');
        document.getElementById('passwordInput').disabled = true;
      } else {
        showError(`密码错误，请重新输入！`);
        document.getElementById('passwordInput').value = '';
      }
    }

    // 显示错误信息
    function showError(message) {
      const errorTip = document.getElementById('errorTip');
      errorTip.textContent = message;
      errorTip.style.display = 'block';

      setTimeout(() => {
        errorTip.style.display = 'none';
      }, 5000);
    }

    // 保存密码到 localStorage
    function savePassword(password) {
      try {
        const encryptedPassword = encryptPasswordForStorage(password);
        if (encryptedPassword) {
          const savedPasswords = JSON.parse(localStorage.getItem('vuepress_encrypted_passwords_') || '{}');
          savedPasswords['universal_aes_key'] = {
            encryptedPassword: encryptedPassword,
            timestamp: Date.now()
          };
          localStorage.setItem('vuepress_encrypted_passwords_', JSON.stringify(savedPasswords));
        }
      } catch (error) {
        console.warn('保存加密密码失败:', error);
      }
    }

    // 尝试使用保存的密码
    function trySavedPassword() {
      try {
        const savedPasswords = JSON.parse(localStorage.getItem('vuepress_encrypted_passwords_') || '{}');
        const savedData = savedPasswords['universal_aes_key'];

        if (savedData && savedData.encryptedPassword) {
          // 检查是否过期（7天）
          const now = Date.now();
          const weekInMs = 7 * 24 * 60 * 60 * 1000;
          if (now - savedData.timestamp < weekInMs) {
            const decryptedPassword = decryptPasswordFromStorage(savedData.encryptedPassword);
            if (decryptedPassword) {
              document.getElementById('passwordInput').value = decryptedPassword;
              document.getElementById('remember').checked = true;
              verifyPassword();
              return;
            }
          }
        }
      } catch (error) {
        console.warn('读取保存的密码失败:', error);
      }
    }

    // 页面加载时尝试使用保存的密码
    window.addEventListener('DOMContentLoaded', trySavedPassword);
  </script>

  <style>
    /* 弹窗样式 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .password-input {
      width: 100%;
      padding: 0.8rem;
      margin: 1rem 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .remember-password {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin: 0.8rem 0;
      font-size: 0.9rem;
      color: #666;
    }
    .remember-password input[type="checkbox"] {
      margin-right: 0.5rem;
    }
    .remember-password label {
      cursor: pointer;
    }
    .btn-group {
      display: flex;
      gap: 1rem;
      margin: 1rem 0;
    }
    .confirm-btn, .reset-btn {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #42b983;
      color: #fff;
    }
    .confirm-btn:hover {
      background: #369870;
    }
    .reset-btn {
      background: #f0f0f0;
      color: #333;
    }
    .reset-btn:hover {
      background: #e0e0e0;
    }
    .error-tip {
      color: #ff4757;
      margin: 0.5rem 0;
      font-size: 0.9rem;
    }
    .count-tip {
      color: #ffa502;
      font-size: 0.8rem;
      margin: 0.5rem 0;
    }
    .access-hint {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    }
    #app {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</body>
</html>